@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script type="text/javascript">
    app.controller('PrepaidBillCtrl', function ($scope, $http) {
        var flag = getQueryString("flag");
        if (flag == "0" || flag == "1") {
            getRooms(flag);
        } else {
            $scope.PageSize = 10;
            var params = {
                "BuildingNo": getQueryString("buildingNo"),
                "RoomNo": getQueryString("roomNo"),
                "Floor": getQueryString("floor"),
                "RealName": "",
                "PageIndex": 1,
                "PageSize": $scope.PageSize
            };
            getInfos(params, true);
        }

        function getRooms(flag) {
            $http({
                method: "get",
                withCredentials: true,
                url: "../api/recommendbills/" + flag
            }).success(function (data, status, headers, config) {
                $scope.Items = data;
            }).error(function (data, status, headers, config) {
                ShowErrModal(data, status);
            });
        }
        
        function getInfos(params, isFirstLoadPager) {
            $http({
                method: "get",
                withCredentials: true,
                url: "../api/prepaidbills",
                params: params
            }).success(function (data, status, headers, config) {
                $scope.Items = data.Items;
                $scope.RecordCount = data.RecordCount;
                if (isFirstLoadPager) {
                    // 分页数据绑定
                    $("#page4").page('destroy');
                    $("#page4").page({
                        total: $scope.RecordCount,
                        pageSize: $scope.PageSize,
                        firstBtnText: '首页',
                        lastBtnText: '尾页',
                        prevBtnText: '上一页',
                        nextBtnText: '下一页',
                        showInfo: false,
                        showJump: true,
                        jumpBtnText: '跳转'
                    }).on("pageClicked", function (event, pageIndex) {
                        params.PageIndex = pageIndex + 1;
                        getInfos(params, false); // 重新绑定数据
                    }).on('jumpClicked', function (event, pageIndex) {
                        params.PageIndex = pageIndex + 1;
                        getInfos(params, false); // 重新绑定数据
                    });
                }
            }).error(function (data, status, headers, config) {
                ShowErrModal(data, status);
            });
        }

        // 结算
        $scope.settleBill = function (RoomNo, IntBilledBalance, DeviceBills) {
            ShowConfirmModal("确定要结算该业主的能耗费用吗?", function () {
                $http({
                    method: "post",
                    withCredentials: true,
                    url: "../api/roombills",
                    params: {
                        "RoomNo": RoomNo,
                        "IntBilledBalance": IntBilledBalance,
                        "DeviceBills": DeviceBills
                    }
                }).success(function (data, status, headers, config) {
                    window.parent.location.href = window.parent.location.href;
                }).error(function (data, status, headers, config) {
                    ShowErrModal(data, status);
                });
            });
        };

        // 导出报表
        $scope.exportReport = function () {
            $http({
                method: "get",
                withCredentials: true,
                url: "../api/export/userprepaidbills",
                params: params
            }).success(function (data, status, headers, config) {
                ShowTipsModel("业主能耗缴费实时账单导出成功！");
                location.href = location.origin + '/' + data;
            }).error(function (data, status, headers, config) {
                ShowErrModal(data, status);
            });
        };

        // 批量结算
        $scope.batchSettle = function () {
            ShowConfirmModal("确定要在当前时刻批量结算业主能耗费用吗?", function () {
                $http({
                    method: "post",
                    withCredentials: true,
                    url: "../api/batch/userenergybills"
                }).success(function (data, status, headers, config) {
                    window.parent.location.href = "../prepaid/list";
                }).error(function (data, status, headers, config) {
                    ShowErrModal(data, status);
                });
            });
        };
    });
</script>
<style>
    .left {
        width:40%;
        font-size:14px;
        height:100%;
    }
    .left > table {
        width:100%;
        line-height: 31px;
        min-height:270px;
        margin-bottom:0px;
        border:1px solid #ddd;
    }
    .user-table {
        text-align: center;
        line-height:23px;
        background:#fff;
        border:1px solid #ddd;
    }
    .user-table tr th {
        text-align: center;
        border: 1px solid #d7d7d7;
    }
    .user-table tr td {
        border: 1px solid #d7d7d7;
    }
    .right {
        width:60%;
    }
    .second {
        width:100%;
        margin-bottom:5px;
        font-size:14px;
    }
    .second-list {
        width:100%;
    }
    .second > span {
        margin: 0 3px;
    }
    .ctrl-table > tr > td {
        line-height:24px;
        border:1px solid #ddd;
    }
</style>
<div ng-controller="PrepaidBillCtrl" class="content-div">
    <div ng-cloak ng-repeat="item in Items" style="width:49%; border: 1px solid #336666;padding: 6px 6px;
         color:#555;border-radius:3px;float:left;background:#e7e7e7;position:relative;">
        <div class="left table-responsive" style="float: left;">
            <table class="table table-condensed table-bordered">
                <tbody>
                    <tr style="font-size:14px;">
                        <td width="30%">单    位:</td>
                        <td width="50%"><b>&nbsp;{{item.BuildingNo}}/{{item.RoomNo}}</b></td>
                    </tr>
                    <tr style="font-size:14px;">
                        <td>业主姓名:</td>
                        <td><b>&nbsp;{{item.RealName}}</b></td>
                    </tr>
                    <tr style="font-size:14px;">
                        <td>联系方式:</td>
                        <td><b>&nbsp;{{item.Phone}}</b></td>
                    </tr>
                    <tr style="font-size:14px;">
                        <td>信用积分:</td>
                        <td><b>&nbsp;{{item.CreditScore}}</b></td>
                    </tr>
                    <tr style="font-size:14px;">
                        <td>信用等级:</td>
                        <td><b style="color:#0033ff;">&nbsp;高级</b></td>
                    </tr>
                    <tr style="font-size:14px;">
                        <td>账户余额:</td>
                        <td><b style="color:#0033ff;">&nbsp;{{item.AccountBalance}}元</b></td>
                    </tr>
                    <tr style="font-size:14px;">
                        <td>可欠费金额:</td>
                        <td><b style="color:#0033ff;">&nbsp;{{item.AccountWarnLimit}}元</b></td>
                    </tr>
                    <tr>
                        <td>
                            <button class="btn btn-primary btn-four" id="btnBillRecord{{$index+1}}" url="room/bills?roomNo={{item.RoomNo}}&buildingNo={{item.BuildingNo}}"
                                    onclick="popDefaultWnd(this.id, '结算记录')">
                                结算记录
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-four" id="btnRechargeRecord{{$index+1}}"
                                    url="room/recharges?roomNo={{item.RoomNo}}&buildingNo={{item.BuildingNo}}" onclick="popDefaultWnd(this.id, '充值记录')">
                                充值记录
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="right" style="float:right;">
            <div class="second">
                <span>当前总能耗:<b style=" color:#999900;">{{item.SumValue}}</b></span>
                <span>当前结算总价格:<b style="color:#ff3300;">{{item.SumMoney}}元</b></span>
                <span>结算后账户余额:<b style="color:#ff3300;">{{item.BilledBalance}}元</b></span>
            </div>
            <div class="second-list" style="position:relative;">
                <table class="user-table table table-condensed" cellpadding="2" cellspacing="0">
                    <thead>
                        <tr>
                            <th width="20%" style="line-height:22px;">设备名称</th>
                            <th width="20%">单价</th>
                            <th width="20%">上次抄表读数</th>
                            <th width="20%">当前抄表读数</th>
                            <th width="20%">价格</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-cloak ng-repeat="device in item.PrepaidDeviceBills">
                            <td style="line-height:22px;">{{device.DeviceName}}</td>
                            <td>{{device.Price}}</td>
                            <td>{{device.PreValue}}</td>
                            <td>{{device.CurValue}}</td>
                            <td>{{device.Money}}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="ctrl" style="width:100%;height:100%;position:absolute;top:0;left:0;">
                    <div style="width:20%;height:100%;border-right:1px solid #ddd;border-left:1px solid #ddd;float:left;border-bottom:1px solid #ddd;"></div>
                    <div style="width:20%;height:100%;float:left;border-bottom:1px solid #ddd;"></div>
                    <div style="width:20%;height:100%;border-right:1px solid #ddd;border-left:1px solid #ddd;float:left;border-bottom:1px solid #ddd;"></div>
                    <div style="width:20%;height:100%;float:left;border-bottom:1px solid #ddd;"></div>
                    <div style="width:20%;height:100%;border-right:1px solid #ddd;border-left:1px solid #ddd;float:left;border-bottom:1px solid #ddd;"></div>
                </div>
            </div>
        </div>
        <div class="ctrl-btn" style="position:absolute;bottom:10px;right:10px;">
            <button type="button" id="btnRecharge{{$index+1}}" class="btn btn-success btn-style"
                    url="recharge/add?roomNo={{item.RoomNo}}" onclick="popDefaultWnd(this.id, '能耗充值')">
                充值
            </button>
            <button type="button" ng-if="item.IntBilledBalance >= 0 && item.IntSumMoney>0" class="btn btn-danger btn-style"
                    ng-click="settleBill(item.RoomNo,item.IntBilledBalance,item.PrepaidDeviceBills)">
                结算
            </button>
        </div>
    </div>
    <div class="width center">
        <div id="page4" class="m-pagination m-center"></div>
    </div>
</div>